<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bridge Time, Plebs!!! - Multijugador</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Esta librería permite hablar con el servidor de Render -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; overflow: hidden; background: #020205; font-family: 'Urbanist', sans-serif; color: white; }
        .glass { background: rgba(10, 10, 15, 0.85); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .btn-royal { background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 15px; }
        .hidden-ui { display: none !important; }
        .mine-button { width: 100px; height: 100px; border-radius: 50%; background: radial-gradient(circle, #f59e0b, #92400e); display: flex; align-items: center; justify-content: center; border: 4px solid white; cursor: pointer; pointer-events: auto; }
    </style>
</head>
<body>

    <div id="main-menu" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-[#020205]">
        <div class="max-w-md w-full flex flex-col items-center">
            <h1 class="text-5xl font-black italic text-center mb-8 uppercase">BRIDGE TIME,<br><span class="text-orange-500">PLEBS!!!</span></h1>
            <div class="w-full space-y-4 glass p-8 rounded-[40px]">
                <input id="user-name-input" type="text" placeholder="NOMBRE" class="w-full bg-white/10 p-4 rounded-xl text-center">
                <input id="bridge-id-input" type="text" value="Cursed-Dynasty" class="w-full bg-white/5 p-2 text-center opacity-50">
                <button onclick="enterGame('pleb')" class="w-full btn-royal p-5 font-black uppercase text-white">Servir (Pleb)</button>
                <button onclick="enterGame('princess')" class="w-full glass p-3 rounded-2xl text-[10px] font-black opacity-50">Queen (Control)</button>
            </div>
        </div>
    </div>

    <div id="game-ui" class="hidden-ui fixed inset-0 pointer-events-none z-10 flex flex-col justify-between p-4">
        <div class="flex justify-between items-start pointer-events-auto">
            <div class="glass p-5 rounded-3xl border-l-4 border-orange-500">
                <p class="text-[10px] font-black text-orange-500 uppercase">CROWN GEMS</p>
                <p class="text-3xl font-black italic"><span id="crowns-display">100</span></p>
            </div>
            <div class="glass p-6 rounded-[35px] border-r-4 border-blue-500">
                <p id="shout-text" class="text-xl italic font-bold uppercase">¡CONSTRUID!</p>
            </div>
        </div>

        <div class="w-full flex flex-col items-center gap-4 pointer-events-auto pb-6">
            <div id="princess-controls" class="hidden-ui flex gap-2 mb-4">
                <button onclick="setPrincessState('rest')" class="glass p-3 rounded-xl text-[10px] font-black">ZZZ</button>
                <button onclick="setPrincessState('normal')" class="glass p-3 rounded-xl text-[10px] font-black">NORM</button>
                <button onclick="setPrincessState('sprint')" class="glass p-3 rounded-xl text-[10px] font-black">FAST</button>
            </div>
            <div class="flex flex-col items-center gap-4">
                <div class="grid grid-cols-4 gap-2 px-2">
                    <button onclick="build(0)" class="glass p-4 rounded-2xl text-center">WOOD<br>50</button>
                    <button onclick="build(1)" class="glass p-4 rounded-2xl text-center">STONE<br>200</button>
                    <button onclick="build(2)" class="glass p-4 rounded-2xl text-center">GOLD<br>1K</button>
                    <button onclick="build(3)" class="glass p-4 rounded-2xl text-center">GEM<br>5K</button>
                </div>
                <div onmousedown="mine()" class="mine-button">MINE</div>
            </div>
        </div>
    </div>

    <script>
        // CAMBIA ESTA URL POR LA DE TU RENDER
        const SERVER_URL = "https://bridgetimeplebsbeta.onrender.com"; 
        const socket = io(SERVER_URL);

        let scene, camera, renderer, princess;
        let blockPool = [], velocityY = 0;
        let state = { crowns: 100, tilesCount: 0, behavior: 'normal', isRunning: false };

        socket.on('init_state', (data) => {
            state.behavior = data.princessBehavior;
            updateBlocks(data.tiles || []);
        });

        socket.on('update_tiles', (tiles) => updateBlocks(tiles));
        socket.on('update_princess', (b) => {
            state.behavior = b;
            document.getElementById('shout-text').innerText = b === 'sprint' ? '¡CORRED!' : '¡CONSTRUID!';
        });

        function enterGame(role) {
            const name = document.getElementById('user-name-input').value;
            const realm = document.getElementById('bridge-id-input').value;
            socket.emit('join_realm', { realmId: realm, name: name });
            document.getElementById('main-menu').classList.add('hidden-ui');
            document.getElementById('game-ui').classList.remove('hidden-ui');
            if(role === 'princess') document.getElementById('princess-controls').classList.remove('hidden-ui');
            init3D();
            state.isRunning = true;
        }

        function init3D() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer();
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);
            scene.add(new THREE.AmbientLight(0xffffff, 0.8));

            // Isla
            const island = new THREE.Mesh(new THREE.BoxGeometry(40, 5, 50), new THREE.MeshStandardMaterial({color: 0x222222}));
            island.position.set(0, -2.5, -25);
            scene.add(island);

            // Princesa
            princess = new THREE.Mesh(new THREE.BoxGeometry(1, 2, 1), new THREE.MeshStandardMaterial({color: 0xff00ff}));
            princess.position.set(0, 1, -10);
            scene.add(princess);

            // Pool de bloques
            for(let i=0; i<500; i++) {
                const b = new THREE.Mesh(new THREE.BoxGeometry(10, 1, 8), new THREE.MeshStandardMaterial({color: 0xffffff}));
                b.position.set(0, -0.5, (i*8)+4);
                b.visible = false;
                scene.add(b);
                blockPool.push(b);
            }
            animate();
        }

        function updateBlocks(tiles) {
            state.tilesCount = tiles.length;
            blockPool.forEach((b, i) => b.visible = i < tiles.length);
        }

        function mine() { state.crowns += 10; document.getElementById('crowns-display').innerText = state.crowns; }
        
        function build(m) {
            const costs = [50, 200, 1000, 5000];
            if(state.crowns >= costs[m]) {
                state.crowns -= costs[m];
                document.getElementById('crowns-display').innerText = state.crowns;
                socket.emit('build_block', { realmId: document.getElementById('bridge-id-input').value, m });
            }
        }

        function setPrincessState(behavior) {
            socket.emit('set_princess', { realmId: document.getElementById('bridge-id-input').value, behavior });
        }

        function animate() {
            requestAnimationFrame(animate);
            if(!state.isRunning) return;
            const spd = state.behavior === 'sprint' ? 0.3 : (state.behavior === 'rest' ? 0 : 0.15);
            princess.position.z += spd;
            camera.position.set(15, 10, princess.position.z - 15);
            camera.lookAt(0, 0, princess.position.z);
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
