<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bridge Time, Plebs!!!</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; overflow: hidden; background: #020205; font-family: 'Urbanist', sans-serif; color: white; touch-action: manipulation; }
        .glass { background: rgba(10, 10, 15, 0.85); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .btn-royal { background: linear-gradient(135deg, #f59e0b, #d97706); transition: all 0.2s; border-radius: 15px; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3); }
        .btn-royal:active { transform: scale(0.9); }
        .btn-royal:disabled { opacity: 0.3; filter: grayscale(1); transform: none; }
        .input-dark { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; border-radius: 12px; padding: 10px; }
        .hidden-ui { display: none !important; }
        .royal-glow { text-shadow: 0 0 10px rgba(245, 158, 11, 0.8); }
        .slide-in { animation: slideIn 0.3s ease-out forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 6px; cursor: pointer; background: rgba(255,255,255,0.1); border-radius: 3px; }
        input[type=range]::-webkit-slider-thumb { height: 18px; width: 18px; border-radius: 50%; background: #f59e0b; cursor: pointer; -webkit-appearance: none; margin-top: -6px; }
    </style>
</head>
<body>

    <!-- MAIN MENU -->
    <div id="main-menu" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-[#020205] overflow-y-auto">
        <div id="menu-home" class="max-w-md w-full flex flex-col items-center py-10 slide-in">
            <h1 class="text-5xl font-black italic tracking-tighter text-center mb-8 uppercase leading-none text-white">BRIDGE TIME,<br><span class="text-orange-500 text-6xl">PLEBS!!!</span></h1>
            <div class="w-full space-y-4">
                <div class="glass p-6 rounded-[30px] border-orange-500/30">
                    <p class="text-[10px] font-black text-orange-500 uppercase tracking-widest mb-2">Dynasty Mode</p>
                    <h3 class="text-xl font-bold mb-3 text-white">The Cursed Dynasty</h3>
                    <button onclick="selectAndEnter('Cursed-Dynasty', 'auto', 'pleb')" class="w-full btn-royal p-4 font-black uppercase italic text-sm mb-2 text-white">Serve Princess Lulienne</button>
                    <div class="mt-4 pt-4 border-t border-white/10">
                        <p class="text-[10px] font-black text-blue-400 uppercase tracking-widest mb-2">Custom Realm</p>
                        <input id="custom-id-input" type="text" placeholder="REALM ID" class="w-full input-dark mb-3 uppercase font-bold text-center text-sm">
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="enterCustom('princess')" class="glass p-3 rounded-xl text-[10px] font-black hover:border-orange-500 uppercase">Be Queen</button>
                            <button onclick="enterCustom('pleb')" class="btn-royal p-3 text-[10px] font-black uppercase text-white">Be Pleb</button>
                        </div>
                    </div>
                </div>
            </div>
            <button onclick="toggleSettings()" class="mt-6 opacity-50 hover:opacity-100 transition-opacity">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            </button>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal" class="hidden-ui fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
        <div class="glass max-w-xs w-full p-8 rounded-[40px] border-white/20 slide-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black italic uppercase tracking-tighter">Settings</h2>
                <button onclick="toggleSettings()" class="text-gray-400 hover:text-white">‚úï</button>
            </div>
            <div class="space-y-6">
                <div>
                    <p class="text-[10px] font-black text-orange-500 uppercase tracking-widest mb-3">Frame Rate Limit</p>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="setFPS(30)" id="fps-30" class="fps-btn glass p-2 rounded-xl text-[10px] font-black">30</button>
                        <button onclick="setFPS(60)" id="fps-60" class="fps-btn glass p-2 rounded-xl text-[10px] font-black border-orange-500">60</button>
                        <button onclick="setFPS(120)" id="fps-120" class="fps-btn glass p-2 rounded-xl text-[10px] font-black">120</button>
                    </div>
                </div>
                <div>
                    <p class="text-[10px] font-black text-orange-500 uppercase tracking-widest mb-3">Master Volume</p>
                    <input type="range" min="0" max="100" value="80" class="w-full" oninput="setVolume(this.value)">
                    <div class="flex justify-between mt-1 opacity-50 text-[10px] font-bold">
                        <span>0%</span>
                        <span id="vol-val">80%</span>
                    </div>
                </div>
            </div>
            <button onclick="toggleSettings()" class="w-full btn-royal mt-8 p-3 font-black uppercase text-xs text-white">Save & Close</button>
        </div>
    </div>

    <!-- GAME UI -->
    <div id="game-ui" class="hidden-ui fixed inset-0 pointer-events-none z-10 flex flex-col justify-between p-4">
        <div class="flex justify-between items-start pointer-events-auto">
            <div class="flex flex-col gap-3">
                <div class="glass p-5 rounded-3xl min-w-[200px] border-l-4 border-orange-500">
                    <p id="hud-realm" class="text-[12px] font-black text-orange-500 uppercase mb-2 tracking-widest">REALM</p>
                    <p class="text-3xl font-black italic"><span id="crowns-display">0</span></p>
                    <p class="text-[10px] font-bold text-gray-400 mt-1 uppercase">Progress: <span id="progress-text">0</span> / 10,000</p>
                </div>
                <button onclick="exitToMenu()" class="glass p-3 rounded-2xl text-[12px] font-black uppercase hover:bg-red-900/20 text-center">üèÉ Abandon</button>
            </div>
            
            <div id="shout-box" class="glass p-6 rounded-[35px] max-w-sm border-r-4 border-blue-500 min-w-[240px]">
                <p class="text-[12px] font-black text-orange-500 uppercase tracking-widest">Her Highness Lulienne:</p>
                <p id="shout-text" class="text-xl italic font-bold uppercase text-center royal-glow leading-tight mt-1">BUILD!</p>
                <div id="demand-tag" class="hidden mt-3 text-[15px] bg-red-900/40 p-2 rounded-xl text-center border border-red-500/50 text-red-200 font-bold uppercase">DEMAND: WOOD</div>
                <div id="status-tag" class="hidden mt-1 text-[10px] font-black text-blue-400 uppercase text-center">SPRINTING</div>
            </div>
        </div>

        <!-- QUEEN CONTROL PANEL -->
        <div id="princess-hud" class="hidden-ui w-full flex flex-col items-center gap-4 pointer-events-auto pb-6">
            <p class="text-[10px] font-black uppercase text-orange-500 tracking-tighter">Queen Control (WASD/Arrows + Space)</p>
            <div class="grid grid-cols-4 gap-2 w-full max-w-2xl px-2">
                <button onclick="setPrincessState('rest')" class="glass p-3 rounded-xl text-[10px] font-black uppercase hover:bg-white/10">Rest</button>
                <button onclick="setPrincessState('sprint')" class="glass p-3 rounded-xl text-[10px] font-black uppercase hover:bg-white/10">Sprint</button>
                <button onclick="setPrincessState('normal')" class="glass p-3 rounded-xl text-[10px] font-black uppercase hover:bg-white/10">Normal</button>
                <select id="quality-selector" onchange="setRequiredQuality(this.value)" class="w-full h-full glass rounded-xl p-3 text-[10px] font-black uppercase appearance-none text-center cursor-pointer">
                    <option value="-1">No Demand</option>
                    <option value="0">Min Wood</option>
                    <option value="1">Min Iron</option>
                    <option value="2">Min Gold</option>
                    <option value="3">Only Diamond</option>
                </select>
            </div>
        </div>

        <!-- PLEB HUD -->
        <div id="pleb-hud" class="w-full flex flex-col items-center gap-6 pointer-events-auto pb-10">
            <div class="grid grid-cols-4 gap-3 w-full max-w-2xl px-2">
                <button id="btn-build-0" onclick="build(0)" class="glass p-4 rounded-2xl text-[13px] font-black uppercase flex flex-col items-center justify-center transition-all">
                    <span class="text-xs font-bold">Wood</span><span class="text-orange-400 font-black text-lg">50</span>
                </button>
                <button id="btn-build-1" onclick="build(1)" class="glass p-4 rounded-2xl text-[13px] font-black uppercase flex flex-col items-center justify-center transition-all">
                    <span class="text-xs font-bold">Iron</span><span class="text-orange-400 font-black text-lg">200</span>
                </button>
                <button id="btn-build-2" onclick="build(2)" class="glass p-4 rounded-2xl text-[13px] font-black uppercase flex flex-col items-center justify-center transition-all">
                    <span class="text-xs font-bold">Gold</span><span class="text-orange-400 font-black text-lg">1k</span>
                </button>
                <button id="btn-build-3" onclick="build(3)" class="glass p-4 rounded-2xl text-[13px] font-black uppercase flex flex-col items-center justify-center transition-all">
                    <span class="text-xs font-bold">Diamond</span><span class="text-orange-400 font-black text-lg">5k</span>
                </button>
            </div>
            <button onmousedown="mine()" class="w-32 h-32 rounded-full btn-royal flex items-center justify-center border-4 border-orange-300/30 shadow-2xl">
                <svg class="w-20 h-20" viewBox="0 0 64 64" fill="none">
                    <rect x="29" y="24" width="6" height="34" rx="2" fill="#3d2111" />
                    <path d="M12 24C12 24 18 16 32 16C46 16 52 24 52 24L46 28C46 28 40 22 32 22C24 22 18 28 18 28L12 24Z" fill="#e2e8f0" />
                    <rect x="28" y="18" width="8" height="10" rx="1.5" fill="#1e293b" />
                </svg>
            </button>
        </div>
    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Tu configuraci√≥n real
        const firebaseConfig = {
          apiKey: "",
          authDomain: "bridgetimeplebs.firebaseapp.com",
          databaseURL: "https://bridgetimeplebs-default-rtdb.firebaseio.com",
          projectId: "bridgetimeplebs",
          storageBucket: "bridgetimeplebs.firebasestorage.app",
          messagingSenderId: "788629984588",
          appId: "1:788629984588:web:7d9acf428d13cd999dabe9"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const appId = 'bridge-v1';

        // Constantes del juego (faltaban en el merge anterior)
        const START_Z = 14.5;
        const BLOCK_SIZE = 8;
        const BRIDGE_WIDTH = 12;
        const ISLAND_Y = 0;
        const BRIDGE_Y = 0.5;
        const MAX_BLOCKS = 10000;
        const MATERIALS = ["WOOD", "IRON", "GOLD", "DIAMOND"];
        const MAT_COLORS = [0x8B4513, 0x708090, 0xFFD700, 0x00FFFF];

        window.state = {
            role: 'pleb',
            realmType: 'auto',
            bridgeId: 'Cursed-Dynasty',
            crowns: 100,
            tiles: [],
            user: null,
            authReady: false,
            syncUnsubscribe: null,
            requiredQuality: -1,
            princessBehavior: 'normal', 
            gameWon: false,
            pVelocity: new THREE.Vector3(0, 0, 0),
            isGrounded: true,
            keys: {},
            fps: 60,
            volume: 80
        };

        let scene, camera, renderer, bridgeGrp, princess, pParts = {};
        let lastTime = 0;

        // Funciones globales para onclick
        window.toggleSettings = () => document.getElementById('settings-modal').classList.toggle('hidden-ui');

        window.setFPS = (val) => {
            window.state.fps = val;
            document.querySelectorAll('.fps-btn').forEach(b => b.classList.remove('border-orange-500'));
            document.getElementById(`fps-${val}`)?.classList.add('border-orange-500');
        };

        window.setVolume = (val) => {
            window.state.volume = val;
            document.getElementById('vol-val').innerText = `${val}%`;
        };

        window.selectAndEnter = (id, type, role) => {
            if (!window.state.authReady) return alert("Autenticaci√≥n no lista a√∫n...");
            window.state.bridgeId = id;
            window.state.realmType = type;
            window.state.role = role;
            startLevel();
        };

        window.enterCustom = (role) => {
            const id = document.getElementById('custom-id-input').value.trim();
            if (id) window.selectAndEnter(id.replace(/\s+/g, '-'), 'human', role);
            else alert("Ingresa un Realm ID");
        };

        window.exitToMenu = () => {
            if (window.state.syncUnsubscribe) window.state.syncUnsubscribe();
            document.getElementById('game-ui').classList.add('hidden-ui');
            document.getElementById('main-menu').classList.remove('hidden-ui');
            if (renderer) { renderer.setAnimationLoop(null); renderer.domElement.remove(); renderer = null; }
        };

        window.setPrincessState = async (behavior) => {
            if (window.state.role !== 'princess' || !window.state.user) return;
            window.state.princessBehavior = behavior;
            await updateDoc(getBridgeDoc(), { princessBehavior: behavior });
        };

        window.setRequiredQuality = async (val) => {
            if (window.state.role !== 'princess' || !window.state.user) return;
            await updateDoc(getBridgeDoc(), { requiredQuality: parseInt(val) });
        };

        window.mine = () => {
            window.state.crowns += 25;
            document.getElementById('crowns-display').innerText = Math.floor(window.state.crowns);
        };

        window.build = async (matIdx) => {
            if (!window.state.user || window.state.tiles.length >= MAX_BLOCKS) return;
            if (window.state.requiredQuality !== -1 && matIdx < window.state.requiredQuality) return;
            const costs = [50, 200, 1000, 5000];
            if (window.state.crowns < costs[matIdx]) return;
            window.state.crowns -= costs[matIdx];
            document.getElementById('crowns-display').innerText = Math.floor(window.state.crowns);
            await updateDoc(getBridgeDoc(), { tiles: arrayUnion({ m: matIdx, t: Date.now() }) });
        };

        const getBridgeDoc = () => doc(db, 'artifacts', appId, 'public', 'data', 'realms', window.state.bridgeId);

        function startLevel() {
            document.getElementById('main-menu').classList.add('hidden-ui');
            document.getElementById('game-ui').classList.remove('hidden-ui');
            document.getElementById('hud-realm').innerText = window.state.bridgeId.toUpperCase();
            const isPrincessManual = (window.state.role === 'princess' && window.state.realmType === 'human');
            document.getElementById('princess-hud').classList.toggle('hidden-ui', !isPrincessManual);
            document.getElementById('pleb-hud').classList.toggle('hidden-ui', window.state.role === 'princess');
            init3D();
            sync();
        }

        function createPrincess() {
            const group = new THREE.Group();
            const skin = new THREE.MeshStandardMaterial({ color: 0xffdbac });
            const dressMat = new THREE.MeshStandardMaterial({ color: 0xff69b4 });
            const goldMat = new THREE.MeshStandardMaterial({ color: 0xffaa00, metalness: 0.8, roughness: 0.2 });
            const body = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 1.1, 2.4, 8), dressMat);
            body.position.y = 1.2; group.add(body);
            const head = new THREE.Mesh(new THREE.BoxGeometry(1.2, 1.2, 1.2), skin);
            head.position.y = 3.0; group.add(head);
            const crown = new THREE.Mesh(new THREE.TorusGeometry(0.4, 0.1, 8, 16), goldMat);
            crown.rotation.x = Math.PI/2; crown.position.y = 3.6; group.add(crown);
            pParts.armL = new THREE.Mesh(new THREE.BoxGeometry(0.4, 1.2, 0.4), skin);
            pParts.armL.position.set(0.8, 2.0, 0); group.add(pParts.armL);
            pParts.armR = new THREE.Mesh(new THREE.BoxGeometry(0.4, 1.2, 0.4), skin);
            pParts.armR.position.set(-0.8, 2.0, 0); group.add(pParts.armR);
            pParts.legL = new THREE.Mesh(new THREE.BoxGeometry(0.5, 1.0, 0.5), skin);
            pParts.legL.position.set(0.3, 0.5, 0); group.add(pParts.legL);
            pParts.legR = new THREE.Mesh(new THREE.BoxGeometry(0.5, 1.0, 0.5), skin);
            pParts.legR.position.set(-0.3, 0.5, 0); group.add(pParts.legR);
            return group;
        }

        function init3D() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0a14);
            camera = new THREE.PerspectiveCamera(65, window.innerWidth / window.innerHeight, 0.1, 2000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);
            const light = new THREE.DirectionalLight(0xffffff, 1.2);
            light.position.set(20, 100, -10);
            scene.add(light);
            scene.add(new THREE.AmbientLight(0x4040ff, 0.4));
            const island = new THREE.Mesh(new THREE.BoxGeometry(40, 4, 30), new THREE.MeshStandardMaterial({ color: 0x111122 }));
            island.position.y = -2 + ISLAND_Y;
            scene.add(island);
            bridgeGrp = new THREE.Group(); scene.add(bridgeGrp);
            princess = createPrincess(); scene.add(princess);
            princess.position.set(0, ISLAND_Y, -5);
            requestAnimationFrame(animate);
        }

        function handlePhysics(time) {
            let moving = false;
            let targetY = ISLAND_Y;
            const zRel = princess.position.z - START_Z;
            const tileIdx = Math.floor(zRel / BLOCK_SIZE);
            const dist = START_Z - princess.position.z;

            if (dist > 0 && dist < 3) targetY = THREE.MathUtils.lerp(ISLAND_Y, BRIDGE_Y, 1 - (dist / 3));
            else if (zRel >= -0.5) targetY = (tileIdx >= 0 && tileIdx < window.state.tiles.length) ? BRIDGE_Y : -50;

            if (window.state.isGrounded) princess.position.y = THREE.MathUtils.lerp(princess.position.y, targetY, 0.15);

            if (window.state.role === 'princess' && window.state.realmType === 'human') {
                const spd = window.state.princessBehavior === 'sprint' ? 0.45 : (window.state.princessBehavior === 'rest' ? 0 : 0.2);
                if (spd > 0) {
                    if (window.state.keys['KeyW'] || window.state.keys['ArrowUp']) { princess.position.z += spd; moving = true; princess.rotation.y = 0; }
                    if (window.state.keys['KeyS'] || window.state.keys['ArrowDown']) { princess.position.z -= spd; moving = true; princess.rotation.y = Math.PI; }
                    if (window.state.keys['KeyA'] || window.state.keys['ArrowLeft']) { princess.position.x += spd; moving = true; princess.rotation.y = -Math.PI/2; }
                    if (window.state.keys['KeyD'] || window.state.keys['ArrowRight']) { princess.position.x -= spd; moving = true; princess.rotation.y = Math.PI/2; }
                }
                if (window.state.keys['Space'] && window.state.isGrounded) { window.state.pVelocity.y = 0.45; window.state.isGrounded = false; }
            } else {
                const autoSpd = window.state.princessBehavior === 'sprint' ? 0.35 : (window.state.princessBehavior === 'rest' ? 0 : 0.15);
                if (autoSpd > 0 && !window.state.gameWon) {
                    const hasP = princess.position.z <= START_Z || (tileIdx >= 0 && tileIdx < window.state.tiles.length);
                    if (hasP && (window.state.requiredQuality < 0 || (window.state.tiles[tileIdx]?.m >= window.state.requiredQuality) || princess.position.z <= START_Z)) {
                        princess.position.z += autoSpd; moving = true;
                    }
                }
            }

            if (!window.state.isGrounded) {
                window.state.pVelocity.y -= 0.025; princess.position.y += window.state.pVelocity.y;
                if (princess.position.y <= targetY) { princess.position.y = targetY; window.state.pVelocity.y = 0; window.state.isGrounded = true; }
            }
            if (princess.position.y < -10) princess.position.set(0, ISLAND_Y, -5);

            if (moving) {
                const c = time * 0.015;
                pParts.legL.rotation.x = Math.sin(c) * 0.7; pParts.legR.rotation.x = Math.sin(c + Math.PI) * 0.7;
                princess.position.y += Math.abs(Math.sin(c * 2)) * 0.06;
            }

            const st = document.getElementById('status-tag');
            if (window.state.princessBehavior !== 'normal') {
                st.innerText = window.state.princessBehavior.toUpperCase(); st.classList.remove('hidden-ui');
            } else st.classList.add('hidden-ui');
        }

        function animate(time) {
            if (!renderer) return;
            requestAnimationFrame(animate);
            const delta = time - lastTime;
            if (delta > 1000 / window.state.fps) {
                lastTime = time - (delta % (1000 / window.state.fps));
                handlePhysics(time);
                camera.position.lerp(new THREE.Vector3(22, 14, princess.position.z - 20), 0.08);
                camera.lookAt(princess.position.x, 2, princess.position.z + 5);
                renderer.render(scene, camera);
            }
        }

        function sync() {
            if (!window.state.user) return;
            window.state.syncUnsubscribe = onSnapshot(getBridgeDoc(), snap => {
                if (snap.exists()) {
                    const data = snap.data();
                    window.state.tiles = data.tiles || [];
                    window.state.requiredQuality = data.requiredQuality ?? -1;
                    window.state.princessBehavior = data.princessBehavior || 'normal';
                    updateUI(); renderBridge();
                } else setDoc(getBridgeDoc(), { tiles: [], requiredQuality: -1, princessBehavior: 'normal' });
            });
        }

        function updateUI() {
            document.getElementById('progress-text').innerText = window.state.tiles.length.toLocaleString();
            const tag = document.getElementById('demand-tag');
            const shout = document.getElementById('shout-text');
            if (window.state.requiredQuality >= 0) {
                tag.innerText = "DEMAND: " + MATERIALS[window.state.requiredQuality];
                tag.classList.remove('hidden'); shout.innerText = "BETTER QUALITY!";
            } else { tag.classList.add('hidden'); shout.innerText = "BUILD FASTER!"; }
            if (window.state.role === 'pleb') {
                for (let i = 0; i < 4; i++) document.getElementById(`btn-build-${i}`).disabled = (window.state.requiredQuality !== -1 && i < window.state.requiredQuality);
            }
        }

        function renderBridge() {
            bridgeGrp.clear();
            window.state.tiles.forEach((t, i) => {
                const mesh = new THREE.Mesh(new THREE.BoxGeometry(BRIDGE_WIDTH, 1.2, BLOCK_SIZE), new THREE.MeshStandardMaterial({ color: MAT_COLORS[t.m], roughness: 0.3, metalness: 0.2 }));
                mesh.position.set(0, BRIDGE_Y - 0.6, START_Z + (i * BLOCK_SIZE) + BLOCK_SIZE / 2);
                bridgeGrp.add(mesh);
            });
        }

        // Inicializaci√≥n an√≥nima
        signInAnonymously(auth).catch(err => console.error("Error auth:", err));

        onAuthStateChanged(auth, user => {
            window.state.user = user;
            window.state.authReady = !!user;
            if (user) console.log("Usuario conectado:", user.uid);
        });

        window.addEventListener('keydown', e => window.state.keys[e.code] = true);
        window.addEventListener('keyup', e => window.state.keys[e.code] = false);

        window.addEventListener('resize', () => {
            if (!renderer) return;
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
